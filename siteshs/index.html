<!DOCTYPE html>
<html lang="fr">
<head>
  <title> L'état des réseaux mobiles </title>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="shortcut icon" href="favicon.ico" />
  <!-- Leaflet and Bootstrap: CSS style -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
    integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
    crossorigin=""/>
    
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol@0.66.2/dist/L.Control.Locate.min.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-geosearch@latest/assets/css/leaflet.css" />
  <link href='https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/leaflet.fullscreen.css' rel='stylesheet' />
  
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
  <link rel="stylesheet" href="style.css" />
  <script src="http://code.jquery.com/jquery-2.0.3.min.js"></script>
</head>
<body>
  <div id="container">
    <div id="sidebar" class="mb-1 row align-items-center">
      <img class="mx-3 logo" src="logo-arcep.svg" style="height:60px">
      <div class="pb-2">
      <span id="titlespan" class="align-middle" style="height: 100px;">Sites indisponibles</span>
      </div>
      <hr>
      <!-- Button trigger modal -->
      <button type="button" class="btn btn-danger" data-toggle="modal" data-target="#mentionsLegales" data-show="true">
        Mentions légales
      </button>
      <div class="ml-3">
        <form class="form-inline">
          <div class="form-group">
            <label for="date-choice" class="m-2">Choisissez une date:</label>
            <select name="date" id="date-choice" class="form-control m-2" onchange="loadTile()"></select>
          </div>
        </form>
      </div>
    </div>
    <div id="mapid"></div>
  </div>
  

  <!-- Modal de mentions légales -->
  <div class="modal fade" id="mentionsLegales" tabindex="-1" role="dialog" aria-labelledby="mentionsLegalesLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="mentionsLegalesLabel">Mentions légales</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          Textes à compléter...
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">C'est compris !</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js" integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA==" crossorigin=""></script>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-ajax/2.1.0/leaflet.ajax.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol@0.67.0/src/L.Control.Locate.min.js"></script>
  <script src="https://unpkg.com/leaflet-geosearch@latest/dist/bundle.min.js"></script>
  <script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/Leaflet.fullscreen.min.js'></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-hash/0.2.1/leaflet-hash.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/leaflet-easyprint@2.1.9/dist/bundle.js"></script>  
  
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV" crossorigin="anonymous"></script>
<script>
  const opcolor = {
      'bytel' : '#67b4e2',
      'free'  : '#084E8E',
      'orange': '#6561A8',
      'sfr'   : '#ee5557',
//      'bytel' : '#33d1ff',
//      'free'  : '#33ff52',
//      'orange': '#ffb200',
//      'sfr'   : '#ff0000',
    };
  const opname = {
      'bytel' : 'Bouygues Telecom',
      'free'  : 'Free',
      'orange': 'Orange',
      'sfr'   : 'SFR',
    };
  const opkeys = Object.keys(opname);
   
  // Initialisation des variables
  var latitude = 46.49389;
  var longitude = 2.602778;
  var map = null;
  var GeoSearchControl = window.GeoSearch.GeoSearchControl;
  var OpenStreetMapProvider = window.GeoSearch.OpenStreetMapProvider;
    
  function geojsonMarkerOptions(feature) {
    return {
      radius: 8,
      fillColor: opcolor[feature.properties.operateur],
      color: "#000000",
      weight: 1,
      opacity: 1,
      fillOpacity: 0.8,
    };
  }

  function onEachFeature(feature, layer) {
    if (feature.properties && feature.properties.operateur) {
      layer.bindPopup(
        '<h5>' + opname[feature.properties.operateur] + '</h5>' +
        '<p class="p-0 m-0"><b>Voix :     </b> ' + feature.properties.voix + '</p>' +
        '<p class="m-0 p-0"><b> Données : </b> ' + feature.properties.data + '</p>' );
    }
  }
  
  function initMap() {
//    map = L.map('mapid').setView([48.835852, 2.388500], 13);
    map = L.map('mapid', {
      fullscreenControl: {
        pseudoFullscreen: false // if true, fullscreen to page width and height
      }
    }).setView([latitude, longitude], 6);

    // On ajoute le fond de carte
    var osmLayer = L.tileLayer('http://tile.openstreetmap.org/{z}/{x}/{y}.png',
      {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright" target="_blank">les contributeurs d’OpenStreetMap</a>',
        maxZoom: 16,
      });

    // On ajoute une échelle en haut à droite
    var scale = L.control.scale({ position: 'topright', imperial:false});

    var hash = new L.Hash(map);

    // On gère la géolocalisation de l'utilisateur
    var location = L.control.locate({
      position: 'topleft',
      setView: 'untilPanOrZoom',
      flyTo: false,
      cacheLocation: true,
      drawMarker: true,
      drawCircle: false,
      showPopup: false,
      keepCurrentZoomLevel: true
    });

    // On définit le fournisseur sur lequel on va s'appuyer pour effectuer les recherches d'adresse
    var provider = new OpenStreetMapProvider({
      params: { countrycodes: 'fr' },
      // On restreint uniquement les recherches pour la France
    });

    // On définit le module de recherche
    var searchControl = new GeoSearchControl({
      provider: provider,
      showMarker: true,
      showPopup: false,
      marker: {
        icon: new L.Icon.Default,
        draggable: false,
        interactive: false
      },
      maxMarkers: 1,
      retainZoomLevel: false,
      animateZoom: true,
      autoClose: true,
      searchLabel: "Entrez l'adresse",
      keepResult: true
    });
    
    /**
    * On ajoute la légende à la carte
    * @param la carte où la légende sera ajoutée
    */
    var legend = L.control( { position: 'bottomleft' } );
    legend.onAdd = function(map) {
      var div = L.DomUtil.create('div', 'info legend');
      // On boucle sur toutes les valeurs et on génère une étiquette avec la bonne couleur pour chaque valeur
      for (var i = 0; i < opkeys.length; i++) {
        div.innerHTML += '<i style="background:' + opcolor[ opkeys[i] ] + '"></i> ' + opname[ opkeys[i] ] + '<br>';
      }
      return div;
    };
    
    // On ajoute toutes les couches à la carte
    osmLayer.addTo(map);
    scale.addTo(map);
    legend.addTo(map);
    map.addControl(searchControl);
    location.addTo(map);
  }
  
  var current_layer = null
  var urlmap = {};

  function loadTile(url) {
    var e = document.getElementById('date-choice')
    var url = e.options[e.selectedIndex].value;
    var xhttp = new XMLHttpRequest();
    xhttp.onload = function() {
      if (!!current_layer) { current_layer.remove(); }
      var geojson = JSON.parse(this.responseText);
      current_layer = L.geoJSON(geojson, {
        pointToLayer: function (feature, latlng) {
          return L.circleMarker(latlng, geojsonMarkerOptions(feature));
        },
        onEachFeature: onEachFeature });
      current_layer.addTo(map);
    };
    xhttp.open("GET", url, true);
    xhttp.send();
  }

  function removeOptions(selectElement) {
    var nboptions = selectElement.options.length - 1;
    for(var i = nboptions; i >= 0; i--) {
      selectElement.remove(i);
    }
  }

  function load() {
    var xhttp = new XMLHttpRequest();
    xhttp.onload = function() {
      var res = JSON.parse(this.responseText)['resources'];
      var keys = [];
      for (var i = 0; i < res.length; i++) {
        if (res[i].format == 'geojson') {
          date = res[i].title.substring(0, 10);
          keys.push(date);
          urlmap[date] = res[i].url;
        }
      }
      keys.sort().reverse();
      var select_menu = document.getElementById('date-choice');
      removeOptions(select_menu);
      for (var i = 0; i < keys.length; i++) {
        var option = document.createElement("option");
        option.text = keys[i];
        option.value = urlmap[keys[i]];
        select_menu.appendChild(option);
      }
      loadTile(urlmap[keys[0]]);
    };
    xhttp.open("GET", 'https://www.data.gouv.fr/api/1/datasets/5f7c7fae9cd6c79b58da3e20/?', true);
    xhttp.setRequestHeader('X-Fields', '{resources{format,title,url}}');
    xhttp.send();
  }

  /**
  * Initialisation à exécuter lorsque le DOM est chargé
  */
  window.onload = function() {
    initMap();
    $("#mentionsLegales").modal('show');
    load();
  };
</script>
</body>