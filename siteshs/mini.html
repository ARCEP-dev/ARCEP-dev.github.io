<!DOCTYPE html>
<html lang="fr">
<head>
  <title>Sites indisponibles</title>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Leaflet and Bootstrap: CSS style -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
    integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
    crossorigin=""/>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet-geosearch@latest/assets/css/leaflet.css" />
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
  <script src="http://code.jquery.com/jquery-2.0.3.min.js"></script>
  <style>
html, body, #container {
  height: 100%;
  width: 100%;
  overflow: hidden;
}

#sidebar {
  float: top;
  width: 100%;
  max-height: 100%;
  height: 60px;
}

#mapid {
  width: 100%;
  /* Firefox */
  height: -moz-calc(100vh - 60px);
  /* WebKit */
  height: -webkit-calc(100% - 60px);
  /* Opera */
  height: -o-calc(100% - 60px);
  /* Standard */
  height: calc(100% - 60px);
}

.info {
  /* Informations */
  padding: 6px 8px;
  font: 14px/16px Arial, Helvetica, sans-serif;
  background: white;
  background: rgba(255, 255, 255, 0.8);
  box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
  border-radius: 5px;
}

.legend {
  /* Légende */
  line-height: 18px;
  color: #555;
}

.legend i {
  width: 18px;
  height: 18px;
  float: left;
  margin-right: 8px;
  opacity: 0.7;
}
  </style>
</head>
<body>
  <div id="container">
    <div id="sidebar" class="row align-items-center">
      <div class="col-sm-5 ml-3">
        <form class="form-inline">
          <div class="form-group">
            <label for="date-choice" class="m-2">Selectionnez une date: </label>
            <select name="date" id="date-choice" class="form-control m-2" onchange="ajaxGetCurrentTile()"></select>
          </div>
        </form>
      </div>
    </div>
    <div id="mapid"></div>
  </div>
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js" integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA==" crossorigin=""></script>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-ajax/2.1.0/leaflet.ajax.min.js"></script>
  <script src="https://unpkg.com/leaflet-geosearch@latest/dist/bundle.min.js"></script>
  
  
  <script src="https://cdn.jsdelivr.net/npm/leaflet-easyprint@2.1.9/dist/bundle.js"></script>  
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
<!--
  -->
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
 
 <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV" crossorigin="anonymous"></script>
<script>
  // Table de conversion des noms opérateurs
  const opname = {
      'bytel' : 'Bouygues Telecom',
      'free'  : 'Free',
      'orange': 'Orange',
      'sfr'   : 'SFR',
    };
  function getName(s) { return opname[s] || s; }
  
  const opnames = ['Bouygues Telecom', 'Free', 'Orange', 'SFR'];
  
  // Table des couleurs opérateurs
  var current_style = 0;
  const opstyles = [
      {'Bouygues Telecom':'#67b4e2','Free':'#084E8E','Orange':'#6561A8','SFR':'#ee5557'},
      {'Bouygues Telecom':'#33d1ff','Free':'#33ff52','Orange':'#ffb200','SFR':'#ff0000'}
    ];
  function getStyle() { return opstyles[ current_style ]; }
  function getColor(s) { return getStyle()[ getName(s) ]; }
  
  // Initialisation des variables
  var latitude = 46.49389;
  var longitude = 2.602778;
  var map = null; // Pointeur vers la carte
  var GeoSearchControl = window.GeoSearch.GeoSearchControl;
  var OpenStreetMapProvider = window.GeoSearch.OpenStreetMapProvider;
  
  // Constructeur de marqueur
  function geojsonMarkerOptions(feature) {
    return {
      radius: 8,
      fillColor: getColor(feature.properties.operateur),
      color: "#000000",
      weight: 1,
      opacity: 1,
      fillOpacity: 0.8,
    };
  }
  
  function initMap() {
    map = L.map('mapid', {}).setView([46.49389, 2.602778], 6);

    // On ajoute le fond de carte
    var osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.fr/osmfr/{z}/{x}/{y}.png',
      {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright" target="_blank">les contributeurs d’OpenStreetMap</a>',
        maxZoom: 16,
      });

    // On ajoute une échelle en haut à droite
    var scale = L.control.scale({ position: 'topright', imperial:false});

    // On définit le fournisseur sur lequel on va s'appuyer pour effectuer les recherches d'adresse
    var provider = new OpenStreetMapProvider({
      params: { countrycodes: 'fr' },
      // On restreint uniquement les recherches pour la France
    });

    // On définit le module de recherche
    var searchControl = new GeoSearchControl({
      provider: provider,
      showMarker: true,
      showPopup: false,
      marker: {
        icon: new L.Icon.Default,
        draggable: false,
        interactive: false
      },
      maxMarkers: 1,
      retainZoomLevel: false,
      animateZoom: true,
      autoClose: true,
      searchLabel: "Entrez l'adresse",
      keepResult: true
    });
    
    /**
    * On ajoute la légende à la carte
    * @param la carte où la légende sera ajoutée
    */
    var legend = L.control( { position: 'bottomleft' } );
    legend.onAdd = function(map) {
      var div = L.DomUtil.create('div', 'info legend');
      // On boucle sur toutes les valeurs et on génère une étiquette avec la bonne couleur pour chaque valeur
      opnames.forEach(function(name) {
        div.innerHTML += '<i style="background:' + getColor(name) + '"></i> ' + name + '<br>';
      });
      return div;
    };
    
    // On ajoute toutes les couches à la carte
    osmLayer.addTo(map);
    scale.addTo(map);
    legend.addTo(map);
    map.addControl(searchControl);
  }
  
var current_layer = null
  var urlmap = {};
  
  // Ajoute une popup à @layer avec les infos contenues dans @feature
  function addFeaturePopup(feature, layer) {
    if (feature.properties && feature.properties.operateur) {
      layer.bindPopup(
        '<h5>' + getName(feature.properties.operateur) + '</h5>' +
        '<p class="p-0 m-0"><b>Voix :     </b> ' + feature.properties.voix + '</p>' +
        '<p class="m-0 p-0"><b> Données : </b> ' + feature.properties.data + '</p>' );
    }
  }
  
  // Construit la couche des points à partir du geoJSON et l'ajoute à map
  function loadLayer(geojson) {
    if (!!current_layer) { current_layer.remove(); }
    current_layer = L.geoJSON(geojson, {
      pointToLayer: function (feature, latlng) {
        return L.circleMarker(latlng, geojsonMarkerOptions(feature));
      },
      onEachFeature: addFeaturePopup });
    current_layer.addTo(map);
  }
  
  // Récupère les données geoJSON à partir de l' @url et charge la couche correspondante
  function ajaxGetLayer(url) {
    var xhttp = new XMLHttpRequest();
    xhttp.onload = function() { loadLayer( JSON.parse(this.responseText) ); };
    xhttp.open("GET", url, true);
    xhttp.send();
  }
  
  // Charge la couche actuellement sélectionnée
  function ajaxGetCurrentTile() {
    var e = document.getElementById('date-choice')
    ajaxGetLayer( e.options[e.selectedIndex].value );
  }

  // Retire toutes les options d'un élément DOM select
  function removeOptions(selectElement) {
    var nboptions = selectElement.options.length - 1;
    for(var i = nboptions; i >= 0; i--) {
      selectElement.remove(i);
    }
  }

  // Charges les @cap dernières dates disponibles dans les données @data
  function loadDates(data, cap) {
    var keys = [];
    for (var i = 0; i < data.length; i++) {
      if (data[i].format == 'geojson') {
        date = data[i].title.substring(0, 10);
        keys.push(date);
        urlmap[date] = data[i].url;
      }
    }
    keys.sort().reverse();
    var select_menu = document.getElementById('date-choice');
    removeOptions(select_menu);
    for (var i = 0; i < Math.min(cap,keys.length); i++) {
      var option = document.createElement("option");
      option.text = keys[i];
      option.value = urlmap[keys[i]];
      select_menu.appendChild(option);
    }
    ajaxGetLayer(urlmap[keys[0]]);
  }
  
  // Récupère et charge les @cap dernières dates
  function ajaxGetDates(cap) {
    var xhttp = new XMLHttpRequest();
    xhttp.onload = function(){ loadDates( JSON.parse(this.responseText)['resources'], cap); };
    xhttp.open("GET", 'https://www.data.gouv.fr/api/1/datasets/5f7c7fae9cd6c79b58da3e20/?', true);
    xhttp.setRequestHeader('X-Fields', '{resources{format,title,url}}');
    xhttp.send();
  }

  // Initialisation à exécuter lorsque le DOM est chargé
  window.onload = function() {
    initMap();
    ajaxGetDates(15);
  };
</script>
</body>